
오늘은 2024 당근 테크 서버 부문 참여 후기를 전하려고 합니다.
세션은 Frontend / Server / Data,ML / Platform 이 있었고, Data 와 Platform 에 관심이 있었으나 현재 Server에 가장 많은 관심을 가지고 있어, 다른 발표를 듣지 못하였지만 추후 Youtube 링크로 공유 해 준다고 하셔서 시간 날 때 챙겨 보기로 했습니다. 

발표는 총 7개이며, 세션당 2~30분 정도의 분량으로 진행하였고 중간에 10분 정도의 휴식과 
4번째 발표 후 30분 정도의 대휴식이 있었습니다. 
## 1. 당근알바 초기 엔지니어링 전략_빠르게,빠르게,더 빠르게
presenter : 박용진 Mark (당근알바팀 서버개발)
### 내용 정리
- 가장 중요한 것에 집중하기  **제품의 생산성**
	- 가설 -> 실험 -> 검증 을 통한 빠른 의사결정 (비용 최소화)
	- 결과 시각화 (Amplitude, Mixpannel 등)
- 필요한 것만 구현하기 **목적**
	- 문제에 대한 해결 방법 제시
	- 실험 . 필요한 만큼만 구현. 결과에 따라 추가 구현
- 효율적 에러 대응 **현재 작업에 집중**
	- 에러 발생 시, 모니터링을 통한 영향도 확인 (Sentry, Grafana, Datadog, Apollo Studio 등 모니터링 툴 활용)
	- 영향도에 따른 후순위 대응 (컨텍스트 전환 최소화)
- 클라이언트와 효율적 **협업**
	- 응답의 데이터 구조를 유연하게 가져가는 것 (Ask for what you need, get exactly that)
	- GraphQL 적용 (엔지니어링 논의 비용 감소)
### 내 생각
사이드 프로젝트를 하며, 함께 했던 분들과 기획 단계부터 여러가지 고민을 많이 하였었고, 진행 단계에서 의견이 조율되지 않아 비용을 많이 사용해왔었는데, 초기 엔지니어링 시 무엇보다 우선되어야 하는 것은 제품을 생산하는 것이라고 생각 되어지는 발표였다.
## 2. 우리 동네 어디까지 좁아지는 거예요_자연 경계로 좁혀보는 우리 동네
presenter : 손진 Geo (GIS , Location Intelligence)
### 내용 정리
- 장소의 범주화 (우리동네에 대한 정의가 무엇일까?)
- 장소의 범위 설정
- S2, H3 도입 시 문제점
	- 사람들이 인식하는 경계, 컨텍스트를 포함시키기 힘들다.
	- Border problem 발생
	- 정확한 영역에 대한 더 많은 메모리 비용 발생
- 경계 기준 설정
	- 일정 거리 이내의 빌딩을 hot spot의 형태로 클러스터링
	- 기존 행정경계 + 토지이용지도 데이터를 overlay
	- 기존 행정경계 + 자연경계 (수계, 도로, 산지, 공원)로 구분
- 우리동네 좁혀보기
	- Voronoi Diagram 을 통한 면 -> 점 -> 면 빈틈 채우기
	- 기존 읍/면/동 보다 훨씬 사용자의 활동반경을 잘 반영하는 형태로 가공
### 내 생각
단순 히 Map Api를 통해 장소 인식을 하여 나누면 되지 않을까 라는 생각이었는데, 단순 보도거리 보다는 공간적 맥락을 포함하여 일관적인 영역으로 관리하여, 사용자의 활동반경을 잘 반영하는 형태로 데이터 조회/분석 하여, 진정한 **하이퍼로컬** 플랫폼으로 작동하며. 임팩트 있는 의사결정을 하도록 인사이트를 제공하는 점에서 큰 감명을 받았습니다.

## 3. 당근 채팅 시스템은 어떻게 만들까
presenter : 권영훈 Andrew.kwon (채팅 서버 개발) , 김기현 Ash  (채팅 서버 개발)
### 내용 정리
- 특징
	- 3900만 대규모 서비스
	- 중고거래, 모임, 알바 등 다양한 채팅 환경
	- 사장님들도 당근 채팅의 웹,모바일 채팅으로 비즈니스
	- 서버에 영구 저장되는 대화 기록
- 히스토리
	- 기존 RDB 사용, SQL 쿼리 튜닝
	- 캐시 추가
	- 서버 Scale Up
- 데이타 불균형에 따른 대량 DB 분리, 설계 (채팅 DB)
	- 샤딩 (엑세스 패턴에 맞는 Shard Key)
	- 메시지,공지사항 : chat_id , 유저정보, 유저의 채팅방 : user_id
- 샤딩 방식
	- Range Sharding : 범위 기반으로 데이터 분산 
	- Lookup Table Sharding : ID와 샤드를 매핑하는 룩업 테이블 사용 
	- Hash Sharding : hash(ID) % 샤드 개수로 분산 
	- Consistent Hashing : 노드 추가/삭제 시 리밸런싱이 용이
- 채택한 DB : DynamoDB
	- 자동 파티셔닝 및 데이터 분산
	- 오토 스케일링
	- 완전 관리형 서비스
	- 유연한 데이터 모델링 (NoSQL)
- 채팅 실시간 API 최적화
	- 최신 메시지 순 채팅방 정렬 - 멀티스레드 (고루틴)
	- 여러 리소스 - 고루틴
	- 메시지 읽음 - 비동기 처리, 이벤트 큐
- 못다한 이야기
	- 채팅 데이터베이스 설계 
		- CQRS 패턴 설계
		- Cache 저장소 패턴
		- TTL 전략 
	- 채팅 API 최적화
		- Bulk 업데이트와 pipeline 처리
		- Replication Lag과 일관성 유지
		- Rate limiting, fallback 처리
### 내생각
초기 RDB 에서 분리하는 작업. 목적에 따른 설계/구현 과정이 인상적이었습니다. 최근 Redis 를 공부하고 있는데, **샤딩**에 대해 한칸 더 다가간 느낌이었습니다. 이전 채팅 시스템 구현 시 어떤 식으로 풀어 나갈지에 대한 고민이 많았었는데 많이 도움이 되었습니다. 못다한 이야기에 대해서도 기회가 있다면 꼭 듣고싶습니다.
## 4. 멈춰버린 세계_네트워크 통신 불가를 해결하기 위한 여정(feat. Istio)
presenter : 정명길 Heshy (당근 페이, SRE) , 김성중 jeremy.kim (당근 페이, 머니서비스) 
### 내용 정리
- 의문에 에러와 연이은 에러들 (Redis Connection Fail, Query Time Out)
- 트래픽 분석 (Work Flow)에 따른 수많은 추정 원인
- 문제 원인 추정 단계
	- 내부 서비스 분리
	- Event Streaming Pattern
	- ZGC 적용
	- RDS Performance Insight 를 통한 부하 분석 및 Query Optimization
	- API Performance Optimization
	- Connection, Read Timeout 조정 (3s , 500ms...)
- 예상 원인에 대한 검증 (Istio Metric - xDS Push Time 급증)
	- 가시화를 통한 원인 유추
	- Istio Proxy Throttle과 CPU Limit 설정
- 테스트
	- 시나리오 작성 및 환경 구성
	- 결과 지표 가시화 (Container CPU, HTTP Latency)
- 검증 및 해결
- 그러나.. 또 다른 문제 발생 (Istio Proxy의 지속적으로 증가하는 자원)
	- CPU, 메모리 사용량 우상
- 교훈
	- 원인이라고 생각했던게 결과는 아닐지 질문해보세요.
	- 네트워크 문제는 앱 개발자와 인프라팀 모두의 힘이 필요해요. 
	- __가시성과 관측성은 빠른 문제 해결과 사후 분석의 기반이 되어요.__ 
	- 결국 이 모든 노력의 끝에는 최상의 사용자 경험이 기다리고 있어요. 
		- Observability: 트래픽, 스레드 상태 등 애플리케이션 상태를 모니터링 
		- Maintainability: 디버깅, 사후 분석 및 유지보수에 용이 
		- Evolvability: 애플리케이션 확장에 대한 방향성 제시 
		- Performance Optimization: 가시성 확보를 통해 성능 개선
		- UX Improvement: 안정성, 가용성, 빠른 문제 해결, 신뢰 있는 금융 시스템
### 내 생각
저도 이전 회사에서 장애 대응에 대한 여러 경험들이 있었습니다. 그러나 3번째 교훈에 대해서는 이번에 많은 배움이 되었습니다. 당근 처럼 큰 서비스도 아니었고, 온프레미스 기반에 솔루션이라 모니터링을 경험하기에는 어려운 환경이었지만, Grafana/Prometheus 와 같은 모니터링 툴을 스터디 할 때 보다 훨씬 더 직관적으로 다가왔습니다. 언제나 좋은 서비스를 위해 노력하는 모든 개발자들을 응원하고 싶습니다...
## 5. 지역 기반으로 중고거래 검색을 샤딩하라
presenter : 임문규 Johnny (검색플랫폼)
### 내용 정리
- 지역 기반 샤딩을 사용하는 이유
	- 단점 : 기존 ES를 통해 이미 샤딩이 되어있었음 
	- 개선안 : 문서를 샤드 수에 맞게 분산 저장이 목표
	- 시도 : hot/cold archtecture -> 여러 문제가 있음
	- 대책안 : 연관 지역이 저장되어 있는 샤드에만 검색 요청
- 구현 방식
	- 샤딩 알고리즘 구현
		- 지역 구조 활용 : hierarchy한 자체 지역 구조
		- 샤드별 밸런스 : 문서량, 쿼리량, 활성 사용자 고려
	- 검토
		- 샤드 수 지정 가능
		- 인접한 지역끼리 샤딩 가능
		- 특정한 weight를 고려 가능
	- 클러스터링 알고리즘 검토
		- K-Means -> balance 가 맞지 않음 -> Weighted K-Means ✅
		- DBSCAN ❌
		- GMM ❌
	- PoC
		- Iterations 
			- 샤드 클러스터링
			- 클러스터 미세 조정 
			- PoC 
		- 작업 효율화 방법
			- 지도로 확인
			- 색인 데이터 백업
- 성능, 비용 체크 및 안정성 검증 
	- Elasticsearch 클러스터 내 적절한 노드/샤드 개수 
	- 특정 지역의 검색 요청이 몇 개의 shard에 검색요청을 하는지
	- 인프라, 서비스의 안정성 체크
- 색인 이슈 발생
	- 샤딩 룰 기반으로 적합한 샤드에 색인을 해야하는 어려움
	- 색인이 제대로 안되는 이유 (elasticsearch의 샤딩 공식에 routing 값)
- 색인 이슈 해결 하기 위한 방법
	- 샤드별로 인덱스를 나누기
	- 역 hash 값을 구하고, 해당 값을 라우팅 테이블로 관리\
- 성능 이슈
	- 원인은 샤드 당 검색 대상 문서 수
- 성능 이슈를 해결하기 위한 방법
	- 샤드를 더 많이 나눠서 샤드 당 문서 수를 줄임 
	- 파티션 추가 
		- 물리적인 공간을 여러개의 논리적인 공간으로 분할하는 기술 
		- 문서를 분산시키고 샤드 간 불균형을 완화함
	- 인덱스 설정으로 파티션 세팅
- 최종 결과 : Latency 감소 및 인프라 비용 절감
- 주의사항 
	- 모든 검색/색인 요청에 라우팅 정보를 넣어줘야 함 
	- ID != Primary Key 
	- 전체지역의 검색 대응 
	- Sharding server가 SPOF
### 내 생각
PPT 기반으로 정리를 하였으나, 실질적으로 뺄 내용이 없어 거의 다 가져왔습니다.. Data를 가져오는 관점에서 위에 DB 관리와 비슷한 맥락이었으나, 최대한 "검색(색인)"의 관점에서 발표 하시려고 정리한 내용인 것 같아 이해가 잘 되었습니다. 
## 6. 빠르게 변하는 운영 도메인에서 살아남는 코드 만들기
presenter : 윤준혁 Julius (운영개발팀)
### 내용 정리
- 운영개발팀은 어떤 팀? 
	- 안전하고 도움 받기 쉬운 당근 만들기 (신고 & 문의 화면)
- 빠르게 변하는 운영 환경
	- 기존에 제공하던 기능(신고, 문의 등)을 새로운 서비스에 대해서도 쉽게 확장 제공
	- 기존 서비스 변경에 빠르게 대응
	- 실시간으로 발생하는 운영 이슈에도 빠르게 대응
- 당근의 문의 처리 도구
	- UI : 제목, 사용자, 카테고리, 내용 등등 기본 틀이 고정되어있음.
- 코드 레벨에서의 확장성과 설정 가능성
	- 문제 : 새로운 서비스 지원 추가 -> 코드 복잡도 증가 -> 디버깅 어려워짐 -> 성능 저하
	- 해결 방법
		- API 분리 (서비스 단위)
		- 역할 분리 (데이터 요청 / 데이터 가공)
		- 메타 프로그래밍 (**신중히 사용할 것**)
		- 규칙 기반 UI 생성
### 내 생각
(사진 이미지가 많아 간략하게 정리하였습니다... )
기존 서비스들의 신고&문의를 유지하면서, 신규 서비스들을 추가한다는게 쉽지는 않을 것 같습니다만. 앞서 말한 이벤트에 대해 최대한으로 유연하게 프로그래밍 하는 방법을 보여주셔서 많이 인상적이었습니다. 
## 7. 당근의 회원 시스템을 마이크로 서비스로 분리하기
presenter : 김기혁 Key (Identity Service , 회원/인증 서비스)
### 내용 정리
- 프로젝트 시작 배경
	- 불안정한 시스템
	- 누적된 기술부채로 확장/변경이 어려움
	- 안정성/확장성이 가능한 시스템으로
	- 모놀리스 -> 마이크로 서비스
	- Ruby on rails -> Golang
- 레거시 코드 이해하기
	- 히스토리를 아는 사람이 없다
	- 데이터 수집 및 가시성 확보
- 시스템 분리
	- 분리의 시작은 API 가져오기
	- 기존 호출을 바꾸면 앱을 강제 업데이트 하도록 해야한다
	- istio 를 활용하여
	- 회원서비스 분리를 도와줄 Sidecar 도입
- 장애없이 안전하게 분리하기
	- 기존 모놀리스 서비스와 신규 로그인 서비스에 대한 Traffic 비율을 점차적으로 증가시키며 장애 최소화
	- 배치를 이용한 DB 동기화
	- 비즈니스 로직 응답 형식 확인 int - float
- 기존 시스템 폐기
	- 모놀리스 서비스 API 요청 제거
	- Sidecar 제거
- 성과
	- 안정성 : 회원 관련 API 성능 개선
	- 확정성 : 전화번호 인증과 강결합된 구조 개선
### 내 생각
**레거시**에 대해서는 대부분의 개발자들이 꺼려하는 부분인것 같습니다.  데이터 수집 및 가시성 확보를 통해 확실한 근거를 가지고 과감히 바꾼다는 것에 많은 의사 결정이 따랐을 걸로 생각됩니다. 언젠간 누군가 해야할 일 이지만, 이 또한 멋지게 해낸 발표자님 외 팀원분들께 👏
## 후기
- 입장 안내 도와주시는 분들이 친절하셔서 찾아가는 것은 어렵지 않았습니다.
- 중간 중간 퀴즈타임을 넣어주셔서 몰입하게 되어 재밌었습니다. (선착순 15명 댓글)
- 프레젠테이션 자료를 모두 공유해 주셔서 넘어간 자료도 다시 보기 편해 좋았습니다.
- 말하고 싶은 내용이 많으셨을 것 같은데 30분 안에 많은 내용을 압축하려고 고생하셨을 것 같다는 생각에 박수를 많이 쳤습니다.
- 평소에 생각했던 고민에 대해서 실무적으로 경험해 보시고 공유해주셨던 것들이 도움이 많이 되었습니다.
- Istio 와 aws 지원하는 여러 제품들에 대한 새로운 지식을 얻게 되어 좋았습니다.
- **당근** 에서는 **사용자의 데이터**에 가치를 두고 개발해 나가는 것이 인상적이었습니다. (우선순위 결정 시)
- 네트워킹 하는 자리에서 질문할 내용을 미리 생각해 두고 참여 하었으면 하는 생각에 아쉬웠습니다.
- 사은품으로 에코벡을 받아서 좋았습니다.

[2024 당근 테크 밋업 가이드](https://daangn.notion.site/2024-2f42802561d14f2bbdf0ef18a2786732)